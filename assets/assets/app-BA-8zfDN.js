function D(e){const n=new Date(e);if(Number.isNaN(n.getTime()))return e;const t=Math.max(0,Date.now()-n.getTime());if(t<36e5){const i=Math.floor(t/6e4)||0;return i<=1?"1 min ago":`${i} min ago`}if(t<864e5){const i=Math.floor(t/36e5);return i<=1?"1 hr ago":`${i} hrs ago`}const o=Math.floor(t/864e5);return o<=1?"1 day ago":`${o} days ago`}function V(){document.querySelectorAll("[data-time]").forEach(e=>{if(e.dataset.timeBound==="1")return;e.dataset.timeBound="1";const n=e.dataset.time;if(!n)return;const t=()=>{e.textContent=D(n)};t();const o=window.setInterval(t,6e4);e.addEventListener("htmx:beforeSwap",()=>window.clearInterval(o),{once:!0})})}function P(e){const n=document.getElementById(e);if(n)return n;const t=document.createElement("div");return t.id=e,t.className="toast-stack",t.setAttribute("aria-live","polite"),document.body.appendChild(t),t}function j(e,n,t={}){const o=t.variant??"info",i=document.createElement("div");i.className=`toast toast--${o}`;const a=document.createElement("span");if(a.textContent=n,i.appendChild(a),t.onAction&&t.actionLabel){const r=document.createElement("button");r.type="button",r.textContent=t.actionLabel,r.addEventListener("click",()=>{t.onAction&&t.onAction(),i.remove()}),i.appendChild(r)}e.appendChild(i);const s=t.timeout??6e3;s>0&&window.setTimeout(()=>{i.classList.add("is-hidden"),window.setTimeout(()=>i.remove(),400)},s)}function v(e,n,t={}){const o=P(e);o&&j(o,n,t)}let c=null,I=null,b=null,y=!1,w=null,L={},g=null,R=!1;function x(e){const n={};return Array.from(e.querySelectorAll("[data-id]")).forEach((o,i)=>{const a=o.dataset.id;a&&(n[a]=i+1)}),n}function M(e,n){const t=Object.keys(e);return t.length!==Object.keys(n).length?!1:t.every(o=>e[o]===n[o])}function $(e){Array.from(e.querySelectorAll("[data-order-input]")).forEach((t,o)=>{t.value=String(o+1)})}function F(e,n){Array.from(e.querySelectorAll("[data-id]")).sort((o,i)=>{const a=o.dataset.id??"",s=i.dataset.id??"";return(n[a]??Number.MAX_SAFE_INTEGER)-(n[s]??Number.MAX_SAFE_INTEGER)}).forEach(o=>e.appendChild(o)),$(e)}function U(e,n){const t={};return Object.entries(e).forEach(([o,i])=>{t[`${n}[${o}]`]=String(i)}),t}function k(e,n){if(!c||!I||M(e,L))return;if(y){w={current:e,previous:n};return}const t={};b!=null&&b.value&&(t._token=b.value),Object.assign(t,U(e,"positions")),n&&Object.assign(t,U(n,"previous_positions")),y=!0;const o=htmx.ajax("POST",I,{values:t,target:"#edition-toast",swap:"none"});o&&o.addEventListener?o.addEventListener("loadend",()=>{if(y=!1,L={...e},w){const i=w;w=null,k(i.current,i.previous)}}):y=!1}function X(){if(!c||!g)return;const e=x(c),n={...g};F(c,n),k(n,e),g=null}function Y(){R||(R=!0,document.body.addEventListener("edition:order-saved",e=>{if(c||(c=document.querySelector("[data-reorder-list]")),!c)return;const t=e.detail??{};g=t.undo?{...t.undo}:null;const o=t.message??"Edition order updated.",i=t.variant??"info";v("edition-toast",o,{variant:i,actionLabel:g?"Undo":void 0,onAction:g?()=>X():null})}))}function G(){const e=document.querySelector("[data-reorder-list]");if(!e||e.dataset.reorderBound==="1")return;const n=e.dataset.reorderEndpoint;if(!n)return;Y(),e.dataset.reorderBound="1",c=e,I=n;const t=e.closest("form");b=(t==null?void 0:t.querySelector('input[name="_token"]'))??null,L=x(e);let o=null,i={...L};Array.from(e.querySelectorAll("[data-id]")).forEach(s=>{s.draggable=!0,s.addEventListener("dragstart",()=>{o=s,i=x(e),s.classList.add("is-dragging")}),s.addEventListener("dragend",()=>{s.classList.remove("is-dragging"),o=null,$(e);const r=x(e);M(r,i)||k(r,i)}),s.addEventListener("dragover",r=>{r.preventDefault();const d=r.currentTarget;if(!o||o===d)return;const E=d.getBoundingClientRect(),f=r.clientY-E.top<E.height/2;e.insertBefore(o,f?d:d.nextSibling)})})}function W(){document.querySelectorAll(".alert[data-auto-dismiss]").forEach(n=>{if(n.dataset.dismissBound==="1")return;const t=parseInt(n.dataset.autoDismiss||"",10);Number.isNaN(t)||t<=0||(n.dataset.dismissBound="1",window.setTimeout(()=>{n.classList.add("is-hidden"),window.setTimeout(()=>{n.remove()},400)},t))})}function z(){window.__editionInfiniteBound||(window.__editionInfiniteBound=!0,document.body.addEventListener("editions:page-loaded",e=>{const t=e.detail??{},o=document.getElementById("edition-list");if(o&&(typeof t.page=="number"&&(o.dataset.editionsCurrent=String(t.page)),!t.next)){const i=document.querySelector(".pagination--fallback");i&&i.classList.add("is-hidden")}}))}function J(){window.__inboxBound||(window.__inboxBound=!0,document.body.addEventListener("inbox:updated",e=>{const t=e.detail??{},o=document.getElementById("inbox-after-id"),i=document.getElementById("inbox-table-body"),a=document.getElementById("admin-inbox-link"),s=a&&a.dataset.inboxCount?Number(a.dataset.inboxCount):0;if(typeof t.latest_id=="number"&&o){const r=Number(o.value||"0");t.latest_id>r&&(o.value=String(t.latest_id))}if(i&&typeof t.latest_id=="number"&&(i.dataset.latestId=String(t.latest_id)),a&&typeof t.count=="number"&&(a.dataset.inboxCount=String(t.count),a.textContent=t.count>0?`Inbox (${t.count})`:"Inbox"),a&&typeof t.count=="number"&&t.count>s){const r=t.count-s;v("inbox-toast",r===1?"1 new inbox item ready.":`${r} new inbox items ready.`,{variant:"info",timeout:5e3})}}))}let l=null,C="/admin/tags/suggest",_="/admin/tags/validate",u=null,m=null,S="",B="";function N(){return l&&document.body.contains(l)||(l=document.querySelector("[data-tags-input]")??null),l}function O(){return document.getElementById("tag-suggestions")}function K(){return document.getElementById("tag-feedback")}function Q(e){return e.split(",").map(n=>n.trim()).filter(n=>n.length>0)}function Z(e){const n=e.split(",").map(i=>i.trim());if(n.length===0)return{active:"",existing:[]};const t=n.pop()??"",o=n.filter(i=>i.length>0);return{active:t,existing:o}}function tt(e){return e.join(", ")}function h(){u&&(u.abort(),u=null);const e=O();e&&(e.innerHTML=""),S=""}function A(e=!1){const n=N(),t=O();if(!n||!t)return;const o=n.value;if(o.trim()===""){h();return}if(!e&&o===S)return;u&&u.abort();const a=Z(o),s=new URLSearchParams;s.set("tags",a.active),s.set("tags_full",o),a.existing.length>0&&s.set("existing",a.existing.join(", ")),u=new AbortController,fetch(`${C}?${s.toString()}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html"},signal:u.signal}).then(r=>{if(!r.ok)throw new Error(`Failed to fetch tag suggestions: ${r.status}`);return r.text()}).then(r=>{t.innerHTML=r,S=o}).catch(r=>{r.name!=="AbortError"&&(console.error("Tag suggestion fetch failed",r),h())}).finally(()=>{u=null})}function p(e=!1){const n=N(),t=K();if(!n||!t)return;const o=n.value;if(!e&&o===B)return;m&&m.abort();const i=new URLSearchParams;i.set("tags",o),m=new AbortController,fetch(`${_}?${i.toString()}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",Accept:"text/html"},signal:m.signal}).then(a=>{if(!a.ok)throw new Error(`Failed to validate tags: ${a.status}`);return a.text()}).then(a=>{t.innerHTML=a,B=o}).catch(a=>{a.name!=="AbortError"&&console.error("Tag validation fetch failed",a)}).finally(()=>{m=null})}function et(){const e=document.querySelector("[data-tags-input]");if(!e||e.dataset.helperBound==="1")return;l=e,C=e.dataset.tagsSuggestUrl??C,_=e.dataset.tagsValidateUrl??_,S="",B="",e.dataset.helperBound="1",e.setAttribute("autocomplete","off"),e.addEventListener("blur",()=>{window.setTimeout(()=>{p()},150)}),e.addEventListener("change",()=>{p(!0)});let n,t;const o=()=>{typeof n<"u"&&window.clearTimeout(n),n=window.setTimeout(()=>{p()},250)},i=()=>{typeof t<"u"&&window.clearTimeout(t),t=window.setTimeout(()=>{A()},150)};e.addEventListener("input",()=>{o(),i()}),e.addEventListener("focus",()=>{A(!0)}),p(!0),window.__tagSuggestionHandler||(window.__tagSuggestionHandler=!0,document.addEventListener("click",a=>{const s=a.target,r=s.closest(".tag-suggestion"),d=N(),E=O();if(!(!d||!E)){if(r){const f=r.dataset.tagName;if(!f)return;const T=Q(d.value);T.some(H=>H.toLowerCase()===f.toLowerCase())||(T.push(f),d.value=tt(T),d.dispatchEvent(new Event("change",{bubbles:!0}))),h(),d.focus(),p(!0),A(!0);return}!s.closest("#tag-suggestions")&&!s.closest("[data-tags-input]")&&h()}}))}function nt(){V(),G(),W(),z(),J(),et()}const q=()=>{nt()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",q,{once:!0}):q();document.addEventListener("htmx:afterSwap",()=>{q()});document.addEventListener("htmx:responseError",e=>{var i;const t=(i=(e.detail||{}).xhr)==null?void 0:i.status,o=typeof t=="number"&&t>0?`Request failed (${t}). Please try again.`:"Request failed. Please try again.";v("app-toasts",o,{variant:"warn",timeout:6e3})});document.addEventListener("htmx:sendError",()=>{v("app-toasts","Network error. Please check your connection.",{variant:"warn",timeout:6e3})});document.addEventListener("htmx:timeout",()=>{v("app-toasts","Request timed out. Please retry.",{variant:"warn",timeout:6e3})});document.addEventListener("click",e=>{const t=e.target.closest("[data-copy]");if(!t)return;const o=t.dataset.copy;o&&navigator.clipboard.writeText(o).catch(()=>{})});document.addEventListener("keydown",e=>{e.key==="Escape"&&h()});
