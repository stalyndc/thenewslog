{% extends 'layout.twig' %}

{% set current_nav = 'admin' %}

{% block title %}Inbox — The News Log{% endblock %}

{% block content %}
<section class="card">
    <div class="badge">Editor Inbox</div>
    <h2>New Items</h2>
    <div id="inbox-toast" class="toast-stack" aria-live="polite"></div>
    {% if message %}
        <div class="alert alert--success" data-auto-dismiss="10000">{{ message }}</div>
    {% endif %}
    {% if error %}
        <div class="alert alert--error" data-auto-dismiss="10000">{{ error }}</div>
    {% endif %}
    <div class="admin-toolbar">
        <form method="post" action="/admin/feeds/refresh" class="admin-toolbar__form">
            {{ csrf_field() }}
            <button type="submit" class="btn btn-primary">Fetch Latest</button>
        </form>
        <a class="btn btn-secondary" href="/admin/feeds">Manage Feeds</a>
        <a class="btn btn-secondary" href="/admin/posts/new">New Post</a>
        <form method="post" action="/admin/logout" class="admin-toolbar__form">
            {{ csrf_field() }}
            <button type="submit" class="btn btn-secondary btn-secondary--accent">Log Out</button>
        </form>
    </div>
    <hr class="section-divider">
    <form method="get" class="form-inline inbox-filter"
          action="/admin/inbox"
          hx-get="/admin/inbox/partial"
          hx-target="#inbox-list"
          hx-swap="innerHTML"
          hx-push-url="true">
        <label for="feed_id">Filter by Feed</label>
        <select id="feed_id" name="feed_id" class="input-control">
            <option value="">All feeds</option>
            {% for feed in feeds %}
                <option value="{{ feed.id }}" {% if selected_feed_id is not null and feed.id == selected_feed_id %}selected{% endif %}>{{ feed.title }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Apply</button>
    </form>
    <div id="inbox-list">
        {% include 'admin/partials/inbox_table.twig' %}
    </div>
    <form id="inbox-poll-state" class="sr-only">
        <input type="hidden" name="after_id" value="{{ latest_id|default(0) }}" id="inbox-after-id">
        <input type="hidden" name="feed_id" value="{{ selected_feed_id|default('') }}" id="inbox-feed-id">
    </form>
    <div id="inbox-poller"
         hx-get="/admin/inbox/poll"
         hx-trigger="load delay:6s, every 45s"
         hx-target="#inbox-table-body"
         hx-swap="afterbegin"
         hx-include="#inbox-poll-state"
         hx-indicator="#inbox-poll-indicator"></div>
    <div id="inbox-poll-indicator" class="poll-indicator htmx-indicator">Checking for new items…</div>
</section>
{% endblock %}
