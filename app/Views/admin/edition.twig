{% extends 'layout.twig' %}

{% set current_nav = 'admin' %}

{% block title %}Manage Edition — The News Log{% endblock %}

{% block content %}
<section class="card card--edition">
    <header class="card__header">
        <div class="badge">Edition • {{ date }}</div>
        <h2>Manage Daily Edition</h2>
        {% if edition %}
            <p class="edition-meta">
                Status: <strong>{{ edition.status|capitalize }}</strong>
                {% if edition.status == 'scheduled' and edition.scheduled_for %}
                    • Scheduled for {{ edition.scheduled_for|date('M j, Y g:ia') }}
                {% endif %}
                {% if edition.published_at %}
                    • Published {{ edition.published_at }}
                {% endif %}
            </p>
        {% endif %}
    </header>

    {% if error %}
        <div class="alert alert--error" data-auto-dismiss="10000">{{ error }}</div>
    {% endif %}

    {% if message %}
        <div class="alert alert--success" data-auto-dismiss="10000">{{ message }}</div>
    {% endif %}

    {% if links is defined and links|length > 0 %}
        <div id="edition-toast" class="toast-stack" aria-live="polite"></div>
        <form method="post" class="form">
            {{ csrf_field() }}
            <div class="order-list" data-reorder-list data-reorder-endpoint="/admin/edition/{{ date }}/reorder">
                {% for link in links %}
                    <div class="order-row" data-id="{{ link.id }}">
                        <input type="number" name="positions[{{ link.id }}]" value="{{ link.position|default(loop.index) }}" min="1" class="input-order" data-order-input>
                        <div class="order-row__body">
                            <p class="order-title">
                                {% if link.is_pinned %}
                                    <span class="order-pin">Pinned</span>
                                {% endif %}
                                {{ link.title }}
                            </p>
                            {% if link.blurb %}
                                <p class="order-blurb">{{ link.blurb }}</p>
                            {% endif %}
                        </div>
                        <div class="order-row__actions">
                            <button type="submit" name="action" value="pin:{{ link.id }}:{% if link.is_pinned %}0{% else %}1{% endif %}" class="btn btn-secondary btn-inline">
                                {% if link.is_pinned %}Unpin{% else %}Pin{% endif %}
                            </button>
                            <a class="order-link" href="/admin/curate/{{ link.item_id }}">Edit</a>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="form-actions">
                <button type="submit" name="action" value="reorder" class="btn btn-primary">Save Order</button>
            </div>
        </form>

        {% set scheduled_value = edition.scheduled_for ? edition.scheduled_for|date('Y-m-d\\TH:i') : '' %}
        <form method="post" class="form form-inline form-schedule" x-data="{ when: '{{ scheduled_value }}' }">
            {{ csrf_field() }}
            <input type="hidden" name="action" value="status">
            <div class="form-group form-group--inline">
                <label for="scheduled_for">Go live at</label>
                <input id="scheduled_for" name="scheduled_for" type="datetime-local" class="input-control input-control--compact" x-model="when" value="{{ scheduled_value }}">
            </div>
            <div class="form-actions form-actions--stacked">
                <button type="submit" name="status" value="draft" class="btn btn-secondary">Save as Draft</button>
                <button type="submit" name="status" value="scheduled" class="btn btn-secondary" :disabled="!when">Schedule Edition</button>
                <button type="submit" name="status" value="published" class="btn btn-primary">Publish Now</button>
            </div>
            <p class="form-hint form-hint--muted" x-show="!when">Pick a date and time to enable scheduling.</p>
        </form>
    {% else %}
        <div class="empty-state">
            <p>No curated links assigned to this edition yet.</p>
        </div>
    {% endif %}
</section>
{% endblock %}
