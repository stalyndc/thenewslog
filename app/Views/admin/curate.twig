{% extends 'layout.twig' %}

{% block title %}Curate — The News Log{% endblock %}

{% block content %}
<section class="card">
    <div class="badge">Curate</div>
    <h2>Curate Item</h2>

    {% if error %}
        <div class="alert alert--error" data-auto-dismiss="10000">{{ error }}</div>
    {% endif %}

    {% if message %}
        <div class="alert alert--success" data-auto-dismiss="10000">{{ message }}</div>
    {% endif %}

    {% if item %}
        <article class="curate-item">
            <h3>{{ item.title }}</h3>
            <p><strong>Feed:</strong> {{ item.feed_title }}</p>
            {% if item.source_name %}
                <p><strong>Source:</strong> {{ item.source_name }}</p>
            {% endif %}
            {% if item.summary_raw %}
                {% set cleaned_summary = item.summary_raw
                    |replace({
                        '</p>': '\n\n',
                        '<br>': '\n',
                        '<br/>': '\n',
                        '<br />': '\n',
                        '\r\n': '\n',
                        '\r': '\n',
                        '&nbsp;': ' '
                    })
                    |striptags %}
                {% if cleaned_summary|trim %}
                    <div class="curate-item__summary">
                        {% for paragraph in cleaned_summary|split('\n\n') %}
                            {% if paragraph|trim %}
                                <p>{{ paragraph|trim }}</p>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            {% endif %}
            <p><a href="{{ item.url }}" target="_blank" rel="noopener">Open original link ↗</a></p>
        </article>

        {% if curated %}
            <section class="curate-existing">
                <h3>Existing Curated Entry</h3>
                <p><strong>Title:</strong> {{ curated.title }}</p>
                <p><strong>Blurb:</strong> {{ curated.blurb }}</p>
                {% if edition %}
                    <p><strong>Edition:</strong> {{ edition.edition_date }} ({{ edition.status|capitalize }})</p>
                {% endif %}
            </section>
        {% endif %}

        <form method="post" class="form">
            {{ csrf_field() }}
            <div class="form-group">
                <label for="title">Curated Title</label>
                <input id="title" name="title" type="text" class="input-control" value="{{ form.title|default('') }}" required>
            </div>

            <div class="form-group">
                <label for="blurb">One-line Blurb</label>
                <textarea id="blurb" name="blurb" class="input-control" rows="3" required>{{ form.blurb|default('') }}</textarea>
            </div>

            <div class="form-group">
                <label for="edition_date">Edition Date</label>
                <input id="edition_date" name="edition_date" type="date" class="input-control" value="{{ form.edition_date|default('') }}" required>
            </div>

            <div class="form-group">
                <label for="tags">Tags (comma separated)</label>
                <input id="tags"
                       name="tags"
                       type="text"
                       class="input-control"
                       value="{{ form.tags|default('') }}"
                       placeholder="e.g. AI, Startups"
                       autocomplete="off"
                       data-tags-input
                       hx-get="/admin/tags/suggest"
                       hx-trigger="keyup changed delay:250ms"
                       hx-target="#tag-suggestions"
                       hx-swap="innerHTML"
                       hx-include="this">
                <div id="tag-feedback">
                    {% include 'admin/partials/tag_feedback.twig' with {'message': null, 'variant': 'muted'} %}
                </div>
                <div id="tag-suggestions" class="tag-suggest-container"></div>
                <div id="tag-validator"
                     hx-get="/admin/tags/validate"
                     hx-trigger="validate-tags from:#tags"
                     hx-target="#tag-feedback"
                     hx-include="#tags"
                     hidden></div>
            </div>

            <div class="form-group form-group--inline">
                <label class="checkbox">
                    <input type="checkbox" name="publish_now" value="1" {% if form.publish_now %}checked{% endif %}>
                    <span>Publish immediately</span>
                </label>
                <label class="checkbox">
                    <input type="checkbox" name="is_pinned" value="1" {% if form.is_pinned %}checked{% endif %}>
                    <span>Pin this link</span>
                </label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Curated Link</button>
            </div>
        </form>

        <form method="post" action="/admin/curate/{{ item.id }}/delete" class="form-inline" onsubmit="return confirm('Delete this item?');">
            {{ csrf_field() }}
            <button type="submit" class="btn btn-secondary">Delete Item</button>
        </form>
    {% else %}
        <div class="empty-state">
            <p>Item not found.</p>
        </div>
    {% endif %}
</section>
{% endblock %}
