<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}The News Log{% endblock %}</title>
    {% if meta_description is defined and meta_description %}
        <meta name="description" content="{{ meta_description }}">
    {% endif %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Work+Sans:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="/assets/css/main.css?v=8">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="shortcut icon" href="/assets/favicon.ico">
    <link rel="alternate" type="application/rss+xml" title="The News Log — Daily Edition" href="/rss/daily.xml">
    {% if canonical_url is defined and canonical_url %}
        <link rel="canonical" href="{{ canonical_url }}">
    {% endif %}
    {% if prev_url is defined and prev_url %}
        <link rel="prev" href="{{ prev_url }}">
    {% endif %}
    {% if next_url is defined and next_url %}
        <link rel="next" href="{{ next_url }}">
    {% endif %}
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQRE4ENQGD"></script>
    <script nonce="{{ csp_nonce }}">
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-TQRE4ENQGD');
    </script>
    {% block head %}{% endblock %}
</head>
<body x-data="appShell()" x-init="init()" @keydown.escape.window="handleEscape()" :class="theme">
<div class="app-shell">
    <header class="app-header">
        <div class="app-header__inner">
            <div class="header-row">
                <p class="brand-title"><a href="/">The News Log</a></p>
                <div class="header-actions">
                    <nav class="app-nav">
                        <a href="/" class="{% if current_nav is defined and current_nav == 'home' %}is-active{% endif %}">Home</a>
                        <a href="/editions" class="{% if current_nav is defined and current_nav == 'editions' %}is-active{% endif %}">Past Editions</a>
                        <a href="/tags" class="{% if current_nav is defined and current_nav == 'tags' %}is-active{% endif %}">Topics</a>
                        <a href="/about" class="{% if current_nav is defined and current_nav == 'about' %}is-active{% endif %}">About</a>
                        {% if is_admin|default(false) or admin_metrics is defined %}
                            <a href="/admin/inbox" class="nav-admin-icon" title="Admin Inbox" aria-label="Admin Inbox">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="26" height="26" stroke-width="1.8" stroke="currentColor" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z"/>
                                </svg>
                                {% if admin_metrics is defined and admin_metrics.inbox_count is not null and admin_metrics.inbox_count > 0 %}
                                    {% set badge = admin_metrics.inbox_count > 99 ? '99+' : admin_metrics.inbox_count %}
                                    <span class="nav-admin-badge">{{ badge }}</span>
                                {% endif %}
                            </a>
                        {% endif %}
                    </nav>
                    <button class="theme-toggle" :aria-label="theme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme'" :title="theme === 'dark' ? 'Light mode' : 'Dark mode'" @click="theme = theme === 'dark' ? 'light' : 'dark'">
                        <!-- Sun icon (stroke like wrench) -->
                        <svg x-show="theme === 'dark'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="4"/>
                            <line x1="12" y1="2" x2="12" y2="5"/>
                            <line x1="12" y1="19" x2="12" y2="22"/>
                            <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"/>
                            <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"/>
                            <line x1="2" y1="12" x2="5" y2="12"/>
                            <line x1="19" y1="12" x2="22" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"/>
                            <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"/>
                        </svg>
                        <!-- Moon icon (stroke) -->
                        <svg x-show="theme === 'light'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 12.8A9 9 0 1 1 11.2 3 7 7 0 0 0 21 12.8Z"/>
                        </svg>
                    </button>
                    <button class="nav-toggle" :aria-expanded="mobileOpen" aria-controls="mobile-drawer" aria-label="Open menu" @click="toggleMobile()">
                        <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <line x1="3" y1="12" x2="21" y2="12" />
                            <line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                </div>
            </div>
            {% if admin_metrics is defined %}
                <div class="admin-meta">
                    <a class="admin-meta__link" href="/admin/inbox" id="admin-inbox-link" data-inbox-count="{{ admin_metrics.inbox_count|default('') }}">Inbox{% if admin_metrics.inbox_count is not null %} ({{ admin_metrics.inbox_count }}){% endif %}</a>
                    {% if admin_metrics.last_fetch %}
                        <span class="admin-meta__status">Last fetch {{ admin_metrics.last_fetch }}</span>
                    {% endif %}
                    {% if admin_metrics.failing_feeds is defined and admin_metrics.failing_feeds > 0 %}
                        <span class="admin-meta__status admin-meta__status--warn">{{ admin_metrics.failing_feeds }} feed{{ admin_metrics.failing_feeds == 1 ? '' : 's' }} failing</span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </header>

    <div id="mobile-drawer-overlay" class="drawer-overlay" :class="{ 'is-open': mobileOpen }" x-show="mobileOpen" x-transition.opacity x-cloak @click="closeMobile()"></div>
    <nav id="mobile-drawer" class="drawer-nav" :class="{ 'is-open': mobileOpen }" x-show="mobileOpen" x-transition x-cloak aria-label="Mobile navigation">
        <div class="drawer-nav__inner">
            <a href="/" class="mobile-link {% if current_nav is defined and current_nav == 'home' %}is-active{% endif %}" @click="closeMobile()">Home</a>
            <a href="/editions" class="mobile-link {% if current_nav is defined and current_nav == 'editions' %}is-active{% endif %}" @click="closeMobile()">Past Editions</a>
            <a href="/tags" class="mobile-link {% if current_nav is defined and current_nav == 'tags' %}is-active{% endif %}" @click="closeMobile()">Topics</a>
            <a href="/about" class="mobile-link {% if current_nav is defined and current_nav == 'about' %}is-active{% endif %}" @click="closeMobile()">About</a>
            {% if is_admin|default(false) or admin_metrics is defined %}
                <a href="/admin/inbox" class="mobile-link {% if current_nav is defined and current_nav == 'admin' %}is-active{% endif %}" @click="closeMobile()">Inbox</a>
            {% endif %}
        </div>
    </nav>

    <main class="app-main">
        <div class="app-main__inner">
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="app-footer">
        <div class="app-footer__inner">
            <span class="footer-copy">&copy; {{ "now"|date("Y") }} The News Log. Crafted for fast, human-curated discovery.</span>
            <nav class="app-footer__nav" aria-label="Legal links">
                <a href="/privacy">Privacy</a>
                <span aria-hidden="true">•</span>
                <a href="/terms">Terms of Use</a>
            </nav>
        </div>
    </footer>
</div>
<script defer src="/assets/vendor/htmx.min.js"></script>
<script defer src="/assets/vendor/alpine.min.js"></script>
<script defer src="/assets/vendor/alpine-persist.min.js"></script>
<script defer src="/assets/vendor/alpine-intersect.min.js"></script>
<script defer src="/assets/vendor/alpine-focus.min.js"></script>
<script defer src="/assets/vendor/alpine-mask.min.js"></script>
<script nonce="{{ csp_nonce }}">
    document.addEventListener('htmx:configRequest', function (event) {
        const token = "{{ csrf_token|e('js') }}";
        event.detail.headers['X-CSRF-TOKEN'] = token;
        event.detail.headers['HX-CSRF-TOKEN'] = token;
    });
</script>
<div x-show="confirmOpen" x-cloak>
    <div class="modal-backdrop" x-show="confirmOpen" x-transition.opacity @click="closeConfirm()"></div>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title" x-show="confirmOpen" x-transition>
        <div class="modal__card">
            <h2 id="confirm-title">Are you sure?</h2>
            <p class="modal__message" x-text="confirmMessage"></p>
            <div class="modal__actions">
                <button type="button" class="btn btn-secondary" @click="closeConfirm()">Cancel</button>
                <button type="button" class="btn btn-primary" @click="runConfirm()">Continue</button>
            </div>
        </div>
    </div>
</div>
<script nonce="{{ csp_nonce }}">
    window.appShell = function appShell() {
        return {
            mobileOpen: false,
            confirmOpen: false,
            confirmMessage: '',
            confirmAction: null,
            // Theme state (dark/light). We persist manually to avoid plugin timing issues.
            theme: 'dark',
            init() {
                document.addEventListener('submit', this._handleSubmit.bind(this), true);
                document.addEventListener('click', this._handleClick.bind(this), true);
                try {
                    const saved = localStorage.getItem('tnl-theme');
                    if (saved === 'light' || saved === 'dark') {
                        this.theme = saved;
                    }
                    if (this.$watch) {
                        this.$watch('theme', (v) => {
                            try { localStorage.setItem('tnl-theme', v); } catch (e) {}
                        });
                    }
                } catch (e) {}
            },
            toggleMobile() {
                this.mobileOpen = !this.mobileOpen;
                document.body.classList.toggle('is-mobile-nav-open', this.mobileOpen);
            },
            closeMobile() {
                if (!this.mobileOpen) {
                    return;
                }
                this.mobileOpen = false;
                document.body.classList.remove('is-mobile-nav-open');
            },
            handleEscape() {
                if (this.confirmOpen) {
                    this.closeConfirm();
                    return;
                }
                if (this.mobileOpen) {
                    this.closeMobile();
                }
            },
            openConfirm(message, action) {
                this.confirmMessage = message || 'Are you sure?';
                this.confirmAction = action;
                this.confirmOpen = true;
                document.body.classList.add('is-modal-open');
            },
            closeConfirm() {
                this.confirmOpen = false;
                this.confirmMessage = '';
                this.confirmAction = null;
                document.body.classList.remove('is-modal-open');
            },
            runConfirm() {
                const action = this.confirmAction;
                this.closeConfirm();
                if (typeof action === 'function') {
                    action();
                }
            },
            _handleSubmit(event) {
                const target = event.target;
                if (!(target instanceof HTMLFormElement)) {
                    return;
                }
                const message = target.dataset.confirm;
                if (!message) {
                    return;
                }
                if (target.dataset.confirming === '1') {
                    delete target.dataset.confirming;
                    return;
                }
                event.preventDefault();
                this.openConfirm(message, () => {
                    target.dataset.confirming = '1';
                    if (typeof target.submit === 'function') {
                        target.submit(); // bypass extra submit handlers
                    } else if (typeof target.requestSubmit === 'function') {
                        target.requestSubmit();
                    }
                    window.setTimeout(() => {
                        delete target.dataset.confirming;
                    }, 0);
                });
            },
            _handleClick(event) {
                const origin = event.target;
                if (!(origin instanceof HTMLElement)) {
                    return;
                }
                const trigger = origin.closest('[data-confirm]');
                if (!trigger || trigger instanceof HTMLFormElement) {
                    return;
                }
                if (trigger.dataset.confirming === '1') {
                    delete trigger.dataset.confirming;
                    return;
                }
                const message = trigger.dataset.confirm || 'Are you sure?';
                event.preventDefault();
                this.openConfirm(message, () => {
                    trigger.dataset.confirming = '1';
                    if (trigger instanceof HTMLElement && typeof trigger.click === 'function') {
                        trigger.click();
                    }
                    window.setTimeout(() => {
                        delete trigger.dataset.confirming;
                    }, 0);
                });
            },
        };
    };
</script>
<link rel="stylesheet" href="/assets/app.css?v=20">
<link rel="preload" href="/assets/app.js?v=20" as="script">
<script defer src="/assets/app.js?v=20"></script>
</body>
</html>
